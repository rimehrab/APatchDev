name: Download APatch ZIP and Upload APK

on:
  push:
    branches: 
      - main  # Trigger on pushes to the main branch

jobs:
  download-and-upload-apk:
    runs-on: ubuntu-latest  # Specify the environment to run in

    steps:
      - name: Checkout code
        uses: actions/checkout@v3  # Checks out the repository

      - name: Download ZIP file
        run: |
          curl -L -o APatch.zip https://nightly.link/bmax121/APatch/workflows/build/main/APatch.zip

      - name: Extract ZIP file
        run: |
          unzip APatch.zip -d APatch  # Extract to a folder named APatch

      - name: Find APK file
        id: find_apk
        run: |
          APK_FILE=$(find APatch -name 'APatch_*-release-signed.apk' | head -n 1)  # Finds the APK file
          echo "APK_FILE=${APK_FILE}" >> $GITHUB_ENV  # Set APK_FILE as an environment variable

      - name: Create Release Tag
        id: create_tag
        run: |
          # Extract the full version from the APK file name
          VERSION=$(basename "${APK_FILE}" | sed -E 's/^APatch_(.*)-release-signed\.apk$/\1/')  # Keep everything between 'APatch_' and '-release-signed.apk'
          echo "TAG=${VERSION}" >> $GITHUB_ENV  # Set the tag as an environment variable

      - name: Remove All Existing Releases
        run: |
          echo "Removing all existing releases..."
          gh release list | awk '{print $1}' | xargs -r gh release delete --yes  # List and delete all releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Token for authentication

      - name: Upload APK to Release
        run: |
          echo "Uploading new release for tag: ${{ env.TAG }}"
        uses: softprops/action-gh-release@v1  # GitHub Action for releasing
        with:
          tag_name: ${{ env.TAG }}  # Use the extracted version as the release tag
          files: ${{ env.APK_FILE }}  # Reference the APK file found earlier
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Token for authentication