import os
import requests
import zipfile

# Read secrets from environment variables
BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
CHAT_ID = os.getenv("TELEGRAM_CHAT_ID")
APK_DIRECTORY = "apk_directory"
ZIP_URL = "https://nightly.link/bmax121/APatch/workflows/build/main/APatch.zip"
ZIP_FILE_PATH = "APatch.zip"

def send_message(text):
    """Send a message to Telegram chat."""
    url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
    payload = {"chat_id": CHAT_ID, "text": text, "parse_mode": "Markdown"}
    response = requests.post(url, json=payload)
    if response.status_code == 200:
        print("Notification sent successfully.")
    else:
        print(f"Failed to send notification: {response.text}")

def download_zip():
    """Download the zip file."""
    response = requests.get(ZIP_URL, stream=True)
    if response.status_code == 200:
        with open(ZIP_FILE_PATH, "wb") as f:
            for chunk in response.iter_content(1024):
                f.write(chunk)
        print("Zip file downloaded.")
        return True
    else:
        print(f"Failed to download zip file: {response.status_code}")
        return False

def extract_apk():
    """Extract APK from the zip."""
    with zipfile.ZipFile(ZIP_FILE_PATH, 'r') as zip_ref:
        apk_files = [f for f in zip_ref.namelist() if f.endswith(".apk")]
        if not apk_files:
            print("No APK found in the zip.")
            return None
        apk_name = apk_files[0]
        apk_path = os.path.join(APK_DIRECTORY, apk_name)

        if os.path.exists(apk_path):
            print(f"APK '{apk_name}' already exists. Skipping extraction.")
            return None

        os.makedirs(APK_DIRECTORY, exist_ok=True)
        zip_ref.extract(apk_name, APK_DIRECTORY)
        print(f"Extracted APK: {apk_name}")
        return apk_name

def cleanup():
    """Delete the downloaded zip file."""
    if os.path.exists(ZIP_FILE_PATH):
        os.remove(ZIP_FILE_PATH)
        print("Zip file deleted.")

def main():
    """Main function."""
    if download_zip():
        apk_name = extract_apk()
        cleanup()

        if apk_name:
            send_message(f"*New APK Uploaded:*\n`{apk_name}`")
        else:
            print("No new APK. Notification skipped.")
    else:
        print("Download failed. Skipping further steps.")

if __name__ == "__main__":
    main()